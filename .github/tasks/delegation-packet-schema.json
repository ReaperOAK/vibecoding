{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "delegation-packet-v1",
  "title": "Delegation Packet Schema",
  "description": "Canonical schema for all task delegation packets in the vibecoding multi-agent system",
  "type": "object",
  "required": [
    "packet_id",
    "issued_by",
    "issued_at",
    "objective",
    "success_criteria",
    "allowed_write_paths",
    "forbidden_paths",
    "max_token_budget",
    "parallel_safe",
    "evidence_requirements"
  ],
  "properties": {
    "packet_id": {
      "type": "string",
      "pattern": "^PKT-[0-9]{8}-[0-9]{6}-[A-Za-z0-9]{6}$",
      "description": "Unique packet identifier: PKT-YYYYMMDD-HHMMSS-XXXXXX"
    },
    "issued_by": {
      "type": "string",
      "const": "ReaperOAK",
      "description": "Only ReaperOAK may issue delegation packets"
    },
    "issued_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of packet creation"
    },
    "target_agent": {
      "type": "string",
      "enum": [
        "Architect",
        "Backend",
        "Frontend",
        "QA",
        "Security",
        "DevOps",
        "ProductManager",
        "Research",
        "Documentation",
        "CIReviewer",
        "UIDesigner",
        "TODO",
        "Validator"
      ]
    },
    "autonomy_level": {
      "type": "string",
      "enum": ["L1", "L2", "L3"],
      "description": "L1=Supervised, L2=Guided, L3=Autonomous"
    },
    "objective": {
      "type": "string",
      "maxLength": 500,
      "description": "Clear success criteria for the task"
    },
    "success_criteria": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "List of verifiable success criteria"
    },
    "allowed_write_paths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Glob patterns for writable paths"
    },
    "forbidden_paths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Glob patterns for forbidden paths"
    },
    "input_artifacts": {
      "type": "array",
      "items": { "type": "string" },
      "description": "File references the agent should read"
    },
    "max_token_budget": {
      "type": "integer",
      "minimum": 1000,
      "maximum": 500000,
      "description": "Maximum token consumption allowed"
    },
    "deadline_ts": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO8601 deadline or null for no deadline"
    },
    "parallel_safe": {
      "type": "boolean",
      "description": "True if task only modifies disjoint paths"
    },
    "evidence_requirements": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "diff_patch",
          "unit_test_output",
          "integration_test_output",
          "lint_output",
          "build_output",
          "security_scan",
          "summary_1line",
          "sarif_report",
          "performance_report"
        ]
      },
      "minItems": 1
    },
    "rollback_plan": {
      "type": "string",
      "description": "Commands or instructions for rollback"
    },
    "watchdog_ttl_seconds": {
      "type": "integer",
      "minimum": 60,
      "maximum": 7200,
      "default": 3600,
      "description": "Maximum execution time before auto-stall"
    },
    "context_budget": {
      "type": "object",
      "properties": {
        "total_tokens": { "type": "integer" },
        "priority_files": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "confidence_threshold": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "default": 70
    },
    "phase": {
      "type": "string",
      "enum": ["DECOMPOSE", "SPEC", "BUILD", "VALIDATE", "GATE", "DOCUMENT", "RETROSPECTIVE"],
      "description": "Current SDLC phase this delegation belongs to"
    },
    "upstream_artifacts": {
      "type": "array",
      "items": { "type": "string" },
      "description": "File paths from prior phases that agent MUST read before starting"
    },
    "todo_task_id": {
      "type": ["string", "null"],
      "pattern": "^[A-Z][A-Z0-9-]*\\d{3,4}$",
      "description": "Specific TODO task ID this delegation executes. Null for DECOMPOSE-phase delegations."
    },
    "todo_acceptance_criteria": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Verifiable acceptance criteria copied from the TODO task"
    },
    "mcp_grants": {
      "type": "array",
      "items": { "type": "string" },
      "description": "MCP server prefixes granted for this task (e.g., 'stitch/', 'playwright/')"
    },
    "fix_loop_context": {
      "type": "object",
      "properties": {
        "iteration": { "type": "integer", "minimum": 1, "maximum": 3 },
        "review_report": { "type": "string", "description": "Path to the review report with findings to fix" },
        "specific_findings": { "type": "array", "items": { "type": "string" } }
      },
      "description": "Present only in fix-loop re-delegations (BUILD phase after VALIDATE failure)"
    },
    "output_contract": {
      "type": "object",
      "properties": {
        "deliverables_dir": { "type": "string" },
        "required_files": { "type": "array", "items": { "type": "string" } },
        "quality_threshold": { "type": "number", "minimum": 0, "maximum": 10 }
      },
      "description": "Structured output expectations for the agent"
    },
    "sdlc_stage": {
      "type": ["string", "null"],
      "enum": ["READY", "LOCKED", "IMPLEMENTING", "QA_REVIEW", "VALIDATION", "DOCUMENTATION", "CI_REVIEW", "COMMIT", "DONE", "REWORK", null],
      "description": "Current ticket state in the 9-state machine. Null if not yet assigned."
    },
    "dod_checklist": {
      "type": ["object", "null"],
      "properties": {
        "code_implemented": { "type": "boolean" },
        "tests_written": { "type": "boolean" },
        "lint_passes": { "type": "boolean" },
        "type_checks_pass": { "type": "boolean" },
        "ci_passes": { "type": "boolean" },
        "docs_updated": { "type": "boolean" },
        "validator_reviewed": { "type": "boolean" },
        "no_console_errors": { "type": "boolean" },
        "no_unhandled_promises": { "type": "boolean" },
        "no_todo_comments": { "type": "boolean" }
      },
      "additionalProperties": false,
      "description": "Definition of Done checklist status. Null until QA_REVIEW state."
    },
    "initialization_checklist": {
      "type": ["object", "null"],
      "properties": {
        "directory_structure": { "type": "boolean" },
        "linter_formatter": { "type": "boolean" },
        "tsconfig": { "type": "boolean" },
        "test_framework": { "type": "boolean" },
        "env_documented": { "type": "boolean" },
        "health_check": { "type": "boolean" },
        "logging": { "type": "boolean" },
        "error_boundaries": { "type": "boolean" },
        "error_tracking": { "type": "boolean" }
      },
      "additionalProperties": false,
      "description": "Project initialization checklist. Null for non-initialization tasks."
    }
  },
  "additionalProperties": false
}
